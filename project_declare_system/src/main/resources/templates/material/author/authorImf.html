<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>作者信息</title>
    <link rel="stylesheet" href="/layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="/layuiadmin/style/admin.css" media="all">
</head>
<body>

<form class="layui-form layui-form-pane" action="" onsubmit="submitFunction()"
      style="margin-left: 300px;margin-top: 20px" lay-filter="demo">

    <!--    申报方式-->
    <div class="layui-form-item">
        <label class="layui-form-label">申报方式</label>
        <div class="layui-input-block">
            <input type="radio" name="writerType" lay-filter="writerType" value="0" title="组织推荐" checked="">
            <input type="radio" name="writerType" lay-filter="writerType" value="1" title="自主申报">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-form-item">
            <!--    作者姓名-->
            <label class="layui-form-label">作者姓名</label>
            <div class="layui-input-inline">
                <input type="text" name="name" lay-verify="required" lay-reqtext="姓名是必填项，岂能为空？" placeholder="请输入"
                       autocomplete="off" class="layui-input">
            </div>
            <!--    性别-->
            <label class="layui-form-label">性别</label>
            <div class="layui-input-inline">
                <input type="radio" name="sex" value="1" title="男" checked="">
                <input type="radio" name="sex" value="0" title="女">
            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-form-item">
            <!--   证件选择-->
            <label class="layui-form-label">证件选择</label>
            <div class="layui-input-inline">
                <select name="identityType" lay-filter="aihao" id="identity">
                    <option value="身份证" selected>身份证</option>
                    <option value="香港永久性居民身份证">香港永久性居民身份证</option>
                    <option value="澳门永久性居民身份证">澳门永久性居民身份证</option>
                    <option value="台湾居民来往大陆通行证">台湾居民来往大陆通行证</option>
                    <option value="护照">护照</option>
                </select>
            </div>
            <!--    证件号-->
            <label class="layui-form-label">证件号</label>
            <div class="layui-input-inline">
                <input type="text" name="personId" lay-verify="identity" placeholder="请输入证件号" autocomplete="off"
                       class="layui-input"
                >
            </div>
        </div>
    </div>
    <!--    手机号和邮箱-->
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-inline">
                <input type="tel" name="phone" lay-verify="required|phone" autocomplete="off" class="layui-input"
                       placeholder="请输入作者的手机号">
            </div>
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-inline">
                <input type="text" name="email" lay-verify="email" autocomplete="off" class="layui-input"
                       placeholder="请输入作者的邮箱">
            </div>
        </div>
    </div>


    <div class="layui-form-item">
        <!--    单位类型-->
        <div id="workType">
            <label class="layui-form-label">单位类型</label>
            <div class="layui-input-inline">
                <select name="workType" lay-filter="aihao" id="com">
                    <option value="0">政府部门</option>
                    <option value="1" selected="">事业单位</option>
                    <option value="2">行政机关</option>
                    <option value="3">国有企业</option>
                    <option value="4">个体经营</option>
                </select>
            </div>
        </div>

        <div id="orgType">
            <label class="layui-form-label">组织类型</label>
            <div class="layui-input-inline">
                <select name="workType" lay-filter="aihao" id="org">
                    <option value="0">组织1</option>
                    <option value="1" selected="">组织2</option>
                    <option value="2">组织3</option>
                    <option value="3">高校4</option>
                    <option value="4">高校5</option>
                </select>
            </div>
        </div>
        <!--    工作单位-->
        <label class="layui-form-label" id="workPlaceText">工作单位</label>
        <label class="layui-form-label" id="recOrg">推荐组织</label>
        <div class="layui-input-inline">
            <input type="text" name="workPlace" lay-verify="title" autocomplete="off" placeholder="请输入作者的工作单位"
                   class="layui-input"
                   value="fffff">
        </div>
    </div>

    <!--    联系地址-->
    <div class="layui-form-item" id="addressDiv">
        <label class="layui-form-label">联系地址</label>
        <div class="layui-input-inline">
            <select name="P1" lay-filter="province" id="province">
                <option></option>
            </select>
        </div>
        <div class="layui-input-inline">
            <select name="C1" lay-filter="city" id="city">
                <option></option>
            </select>
        </div>
        <div class="layui-input-inline">
            <select name="A1" lay-filter="area" id="area">
                <option></option>
            </select>
        </div>
        <div class="layui-input-inline" id="addressDetail">
            <input id="address" type="text" name="assoDetailPlace" lay-verify="title" autocomplete="off"
                   placeholder="请输入具体地址" class="layui-input" style="width: 120%;">
            <dl id="addressTip" class="addressDl">
            </dl>
        </div>
    </div>

    <!--    紧急联系人电话-->
    <div class="layui-form-item">
        <div class="layui-inline">
            <label class="layui-form-label" id="quickPhone">紧急联系人电话</label>
            <label class="layui-form-label" id="orgPhone">组织联系电话</label>
            <div class="layui-input-inline">
                <input type="tel" name="secPhone" lay-verify="required|phone" autocomplete="off" class="layui-input"
                       value="18780185944">
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <div class="layui-input-block">
            <button id="submitButton" class="layui-btn" lay-filter="LAY-user-a-submit" lay-submit=""
                    style="display:none">立即提交
            </button>
        </div>
    </div>

</form>

<script type="text/javascript" src="/js/jquery-1.11.3.js"></script>
<script src="/layuiadmin/layui/layui.js"></script>
<script src="/js/select.js" type="text/javascript" charset="utf-8"></script>
<script>
    $(document).ready(function () {
        orgInfo();
        init()
    });

    function init() {
        var localTest = layui.sessionData('test');
        var phoneNumber = localTest.phoneNumber;
        var formId = localTest.formId;

        layui.use(['form', 'layer'], function () {
                var form = layui.form; //只有执行了这一步，部分表单元素才会自动修饰成功
                var layer = layui.layer;
                if (formId !== undefined) {
                    $.ajax({
                        url: '/author/' + formId,	//这是后端接口的url
                        method: 'get',
                        success: function (res) {
                            console.log("Backend")
                            console.log(res.data)
                            console.log("end")
                            if (res.data.writerType === 0) {
                                orgInfo()
                            } else {
                                personInfo()
                            }
                            var d = res.data;
                            var retrieveMsg = {
                                "id": d.id,
                                "writerPhoneNumber": d.writerPhoneNumber,
                                //申请表类别
                                "name": d.name,
                                "sex": String(d.sex),
                                "email": d.email,
                                "phone": d.phone,
                                //单位类型-组织类型
                                // "workType":String(d.workType),
                                // "P1":String(d.province),
                                // "C1":String(d.city),
                                // "A1":String(d.area),
                                //申请组织or个人,申报方式
                                "writerType": String(d.writerType),
                                "identityType": String(d.identityType),
                                "personId": d.personId,
                                "assoDetailPlace": d.assoDetailPlace,
                                //组织联系电话，紧急电话
                                "secPhone": d.secPhone
                            };

                            form.val("demo", retrieveMsg)

                            setTimeout(() => {
                                set_select_checked("identity", d.identityType)
                                set_select_checked("province", d.province);
                                set_select_checked("city", d.city);
                                set_select_checked("area", d.area);
                                set_select_checked("com", d.workType);
                                set_select_checked("org", d.workType);
                                form.render()
                            }, 500)
                            console.log("city:" + d.city)

                            console.log((city))
                            // form.val("demo",res.data)
                        },
                    })
                } else {
                    orgInfo()
                }
            }
        )
    }

    function set_select_checked(selectId, checkValue) {
        $('select[id=' + selectId + ']').next().find('.layui-anim').children('dd[lay-value=' + checkValue + ']').click();
    }

    //组织界面
    function orgInfo() {
        //显示
        var recOrg = document.getElementById("recOrg");
        recOrg.style = "";
        var orgType = document.getElementById("orgType");
        orgType.style = "";
        var orgPhone = document.getElementById("orgPhone");
        orgPhone.style = "width: 140px";
        //隐藏
        var workPlaceText = document.getElementById("workPlaceText");
        workPlaceText.style = "display:none";
        var workType = document.getElementById("workType");
        workType.style = "display:none";
        var quickPhone = document.getElementById("quickPhone");
        quickPhone.style = "display:none";
    }

    //个人界面
    function personInfo() {
        //显示
        var workPlaceText = document.getElementById("workPlaceText");
        workPlaceText.style = "";
        var orgType = document.getElementById("workType");
        orgType.style = "";
        var quickPhone = document.getElementById("quickPhone");
        quickPhone.style = "width: 140px";
        //隐藏
        var nameChange = document.getElementById("recOrg");
        nameChange.style = "display:none";
        var workType = document.getElementById("orgType");
        workType.style = "display:none";
        var orgPhone = document.getElementById("orgPhone");
        orgPhone.style = "display:none";
    }

    function submitInfo() {
        console.log("iframe-author方法被调用");
        document.getElementById("submitButton").click();
    }


    //提交
    layui.use('form', function () {
        var layer = layui.layer,
            form = layui.form,
            $ = layui.$;

        //监听多选框点击事件  主要是通过 lay-filter="sex"  来监听
        form.on('radio(writerType)', function (data) {
            console.log(data.value);　　//打印当前选择的信息
            if (data.value == 0) {　　　　　　//组织
                orgInfo()
            } else {
                personInfo()
            }
        });


        console.log("执行form");

        //监听提交
        form.on('submit(LAY-user-a-submit)', function (data) {
            layer.msg(JSON.stringify(data.field));
            console.log(data.field);
            console.log("数据处理");

            var localTest = layui.sessionData('test');
            var phoneNumber = localTest.phoneNumber;
            var formId = localTest.formId;

            var d = data.field;
            var sendMsg = {
                "id": formId,
                "writerPhoneNumber": phoneNumber,
                //申请表类别
                "name": d.name,
                "sex": d.sex,
                "email": d.email,
                "phone": d.phone,
                //单位类型-组织类型
                "workType": d.workType,
                "province": d.P1,
                "city": d.C1,
                "area": d.A1,
                //申请组织or个人,申报方式
                "writerType": d.writerType,
                "identityType": d.identityType,
                "personId": d.personId,
                "assoDetailPlace": d.assoDetailPlace,
                //组织联系电话，紧急电话
                "secPhone": d.secPhone
            };
            if (d.writerType == 0) {
                //工作单位
                console.log("推荐组织");
                sendMsg.workPlace = ""
                sendMsg.recOrg = d.workPlace
            } else {
                //推荐组织
                console.log("工作单位");
                sendMsg.workPlace = d.workPlace
                sendMsg.recOrg = ""

            }
            console.log(sendMsg);
            var valid = (data.elem.validity.valid)
            console.log(valid)
            if (valid) {
                window.parent.skipNode(1);
                window.parent.nextPage();
            }
            var url = '/author/update';
            $.ajax({
                type: 'POST',
                url: url,
                dataType: "JSON",
                data: JSON.stringify(sendMsg),
                contentType: "application/json",
                success: function (res) {
                    console.log("后端数据——")
                    console.log(res)
                },
                error: function (reason) {
                    console.log(reason);
                    layer.msg('失败', {time: 3000}, function () {
                    });
                }

            })
            return false;
        });
    });
</script>
</body>
</html>